# HTTP API и команды бота

## Telegram-команды
| Команда | Что делает | Код | Пример использования |
|---------|------------|-----|----------------------|
| `/start` | Приветствие, ссылка на документацию (inline-кнопка). Требует импорта `Markup` в `src/bot/telegraf.js`. | `src/bot/telegraf.js`, строки 34-40 | После перехода по ссылке `/start` → бот отвечает приветствием.
| `/whoami` | Возвращает Telegram ID пользователя. | `src/bot/telegraf.js`, строки 42-48 | Пользователь пишет `/whoami` → ответ `Your Telegram ID: <id>`.
| `/ads` | Запускает сцену `ads-wizard` для создания оффера с поэтапными подсказками. | `src/bot/telegraf.js`, строка 50 | Ввести `/ads`, далее следовать шагам мастера (см. ниже).
| `/cancel` / `Отмена` (внутри сцены) | Прерывает мастер. | `src/bot/adsWizard.js` | В любой момент сцены ввести `/cancel` или написать `Отмена` → бот подтверждает отмену.

### Сцена `ads-wizard`
Файл `src/bot/adsWizard.js` реализует продвинутый мастер. Общие правила:
- на каждом шаге доступны команды `[Назад]` (кнопка/сообщение) и `[Отмена]`;
- ссылка валидируется и проверяется через `getChat` → бот убеждается, что цель существует и доступна;
- итоговый экран показывает HTML-резюме с подсветкой всех полей перед подтверждением.

Ключевые шаги:
1. **Старт и аудит** — инициализация, сохранение `user_id`, `chat_id`, времени запуска мастера.
2. **Проверка ссылки** — поддерживаются публичные `@username` и `t.me/c/...`; при ошибке выводятся дружелюбные подсказки.
3. **Выбор события** — кнопки `EVENT_ORDER` с проверкой совместимости (например, `join_group` → только группы/каналы, `reaction` и `comment` → нужны ссылки на сообщение, для `comment` обязательна ссылка на обсуждение с `?comment=`/`?thread=`, `start_bot` → бот/мини‑апп с параметром `start=` или `startapp=`, `paid` → либо сообщение с оплатой, либо бот со стартовым параметром).
4. **Ставки** — базовая и премиум, обе сверяются с `config.MIN_RATES`, premium ≥ base.
5. **Капы** — общий лимит (целое число ≥ 0) и окно в формате `N/day|hour|week|month` или `0`.
6. **Временной таргетинг** — пресеты (`24/7`, «Будни», «09–18», «Выходные») или ручной JSON c `BYDAY`/`BYHOUR`.
7. **Название и slug** — генерация slug через `slugify` + `ensureUniqueSlug`; пользователь может оставить (`-`) или задать свой. При конфликте бот предлагает свободный вариант.
8. **Резюме** — HTML-обзор полей (ссылка, чат, ставки, капы, таргетинг, slug) и кнопки «Подтвердить»/«Назад»/«Отмена».

После подтверждения оффер сохраняется в `offers` (с `caps_window`, `time_targeting`, `chat_ref`, если колонки доступны), добавляется запись в `offer_audit_log`, а в консоль выводятся ключевые решения (`target resolved`, конфликт slug, `offer inserted`).

## HTTP API
| Метод и путь | Описание | Авторизация | Код |
|--------------|----------|-------------|-----|
| `POST /debug/seed_offer` | Создаёт оффер с произвольными параметрами (debug). Требует заголовок `x-debug-token`. | `x-debug-token == DEBUG_TOKEN` | `src/api/server.js`, строки 24-38 |
| `POST /debug/complete` | Отправляет тестовый постбек в CPA-сеть для оффера/uid. | `x-debug-token == DEBUG_TOKEN` | `src/api/server.js`, строки 44-55 |
| `GET /health` | Health-check, возвращает `{ ok: true }`. | Без авторизации | `src/api/server.js`, строка 58 |
| `POST /bot/webhook` | Проксирует обновления Telegram в Telegraf. | Telegram | `src/api/server.js`, строка 60 |
| `GET /click/:offerId` | Запись клика, выдача `start`-токена и редирект в Telegram. Валидирует UUID. | Без авторизации | `src/api/server.js`, строки 62-84 |
| `GET /s/:shareToken` | Заглушка share-click (TODO: учёт уникальности). | Без авторизации | `src/api/server.js`, строки 86-94 |
| `POST /postbacks/relay` | Принимает постбек от внешних ботов (нужны `offer_id`, `user_id`, `event`). Подписывает и ретранслирует в CPA. | Публичный (но проверяет атрибуцию) | `src/api/server.js`, строки 96-132 |

### Примеры curl
```bash
# Health-check
curl -s http://localhost:3000/health
# Debug seed (нужен DEBUG_TOKEN в ENV)
curl -H "x-debug-token: $DEBUG_TOKEN" -H "Content-Type: application/json" \
  -d '{"target_url":"https://t.me/example","event_type":"start_bot","name":"Test","slug":"test-offer","base_rate":10,"premium_rate":15}' \
  http://localhost:3000/debug/seed_offer
```

## Webhook Telegram
- Установить через `setWebhook` на `$BASE_URL/bot/webhook` (пример в `README.md`).
- PM2-процесс `tg-api` всегда держит API запущенным; webhook не требует отдельного процесса бота.

## TODO
- Реализовать учёт уникальных переходов в `/s/:shareToken` (см. комментарий TODO в коде).
- Исправить отсутствующие импорты (`config`, `Markup`, `crypto`) перед деплоем (P0 в ROADMAP).
