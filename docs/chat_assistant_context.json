{
  "project": "tgbotcpa",
  "purpose": "Telegram-бот для задач/рекла и трекинга конверсий",
  "stack": {
    "runtime": "Node.js 20",
    "frameworks": ["Express", "Telegraf"],
    "process": "PM2",
    "db": "PostgreSQL"
  },
  "entrypoints": [
    "src/api/server.js",
    "ecosystem.config.cjs"
  ],
  "commands": {
    "start": "node src/api/server.js",
    "api": "node src/api/server.js",
    "bot": "node src/bot/run-bot.js",
    "migrate": "node src/db/migrate.js",
    "test": "node --test"
  },
  "env": {
    "BOT_TOKEN": "string|required|Telegram bot token для Telegraf",
    "BASE_URL": "url|required|Базовый URL для генерации /click редиректов",
    "PORT": "number|optional|Порт HTTP сервера (default 3000)",
    "DATABASE_URL": "url|required|PostgreSQL connection string",
    "CPA_POSTBACK_URL": "url|required|Endpoint CPA сети для постбеков",
    "CPA_PB_SECRET": "string|recommended|HMAC секрет для подписи postback",
    "ALLOWED_UPDATES": "csv|optional|Список типов апдейтов Telegram",
    "TZ": "string|optional|Часовой пояс приложения",
    "DEBUG_TOKEN": "string|optional|required-for-debug|Токен доступа к /debug/*",
    "WEBHOOK_PATH": "string|optional|Путь вебхука Telegram",
    "NODE_ENV": "string|optional|dev включает polling в telegraf"
  },
  "workflows": [
    "ads_wizard: шаги → валидации → запись в offers + audit",
    "offer_creation: /ads сцена создаёт slug и ссылку /click",
    "postback/webhook: /postbacks/relay → ищет attribution → axios.post CPA",
    "deploy: PR→merge→GHA Deploy via SSH→git reset --hard→npm ci→pm2 reload"
  ],
  "repo_map": [
    { "path": "src/api/app.js", "role": "Express-приложение и HTTP-эндпоинты" },
    { "path": "src/bot/adsWizard.js", "role": "Wizard сцена /ads" },
    { "path": "src/bot/telegraf.js", "role": "Инициализация бота и команды" },
    { "path": "ecosystem.config.cjs", "role": "PM2 конфигурация" },
    { "path": "package.json", "role": "npm-скрипты и зависимости" }
  ],
  "healthcheck": {
    "path": "/health",
    "expect": "200 OK {\"ok\":true}",
    "note": "Доступно через Express, без авторизации"
  },
  "next_steps": [
    "P0: починить src/api/server.js, чтобы использовать createApp() и корректные импорты",
    "P0: обновить workflow .github/workflows/test.yml или добавить npm script test:ci",
    "P0: включить npm run migrate в деплой-скрипте (deploy.yml и/или серверный чеклист)"
  ]
}
